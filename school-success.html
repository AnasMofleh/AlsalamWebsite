<!DOCTYPE html>
<html lang="sv">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Success</title>
    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet">
</head>

<body class="success-page">
    <div id="loading">Laddar...</div>

    <div id="info" style="display: none;"></div>

    <script>
        // Function to show the loading message with dots
        const showLoading = () => {
            let dots = 0;
            const loadingEl = document.getElementById("loading");
            return setInterval(() => {
                dots = (dots + 1) % 4;
                loadingEl.textContent = "Laddar" + ".".repeat(dots);
            }, 500);
        };

        window.onload = async function () {
            const loadingInterval = showLoading(); // Show loading message

            try {
                const urlParams = new URLSearchParams(window.location.search);
                const sessionId = urlParams.get('session_id');
                    const isLocal = window.location.hostname === "localhost";

                // Send data to Google Apps Script (updatePayments function)
                const scriptResponse = await fetch("https://script.google.com/macros/s/AKfycbwWHS1yB_oEpYHk16T3OOkHetyeBcGh0RHSXk518U5_lbHee9Ne4W0djxm6HwI6t1V7Hw/exec", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({
                        action: "updatePayments",
                        "session_id": sessionId,
                        "env": isLocal ? "test" : "prod"
                    })
                });

                const data = await scriptResponse.json(); // Response from Google Apps Script

                // Stop loading animation
                clearInterval(loadingInterval);
                document.getElementById("loading").style.display = "none";
                const infoBox = document.getElementById("info");
                infoBox.style.display = "block"; // Show the info box

                const { headers, rows } = data; // Extract headers and row data from the response

                let tableHTML = `
                <h2>Tack för din registrering!</h2>
                <p>Vi har registrerat följande information:</p>
            `;

                // Define which headers are for the parent and which for the child
                const parentFields = [
                    "Pappans Förnamn", "Pappans Efternamn", "Pappans Personnummer", "Pappans Mobilenummer", "Pappans Email",
                    "Mammans Förnamn", "Mammans Efternamn", "Mammans Personnummer", "Mammans Mobilnummer", "Mammans Email",
                    "kontaktForälder", "Address", "Postnummer", "Postort", "RegistreringsDatum"
                ];

                const childFields = [
                    "Barnets Namn", "Barnets Personnummer", "skoldag", "Månatligbetalning"
                ];

                // Get column indexes
                const parentIndexes = parentFields.map(f => headers.indexOf(f)).filter(i => i !== -1);
                const childIndexes = childFields.map(f => headers.indexOf(f)).filter(i => i !== -1);

                // Extract parent info from first row
                const parentRow = rows[0];

                // Render parent info once
                tableHTML += `
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                    <caption style="text-align: left; font-weight: bold; margin-bottom: 8px;">Föräldrainformation</caption>
                    ${parentIndexes.map(i => `
                        <tr>
                            <td style="border: 1px solid #ccc; padding: 6px;"><strong>${headers[i]}</strong></td>
                            <td style="border: 1px solid #ccc; padding: 6px;">${parentRow[i]}</td>
                        </tr>
                    `).join('')}
                </table>
            `;

                // Render children table
                tableHTML += `
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                    <caption style="text-align: left; font-weight: bold; margin-bottom: 8px;">Registrerade barn</caption>
                    <tr>
                        ${childIndexes.map(i => `
                            <th style="border: 1px solid #ccc; padding: 6px; background-color: #f0f0f0;">${headers[i]}</th>
                        `).join('')}
                    </tr>
                    ${rows.map(row => `
                        <tr>
                            ${childIndexes.map(i => `
                                <td style="border: 1px solid #ccc; padding: 6px;">${row[i]}</td>
                            `).join('')}
                        </tr>
                    `).join('')}
                </table>
            `;

                // Add back button
                tableHTML += `
                <div style="text-align: center;">
                    <button class="donation-btn" onclick="window.location.href='/'" style="
                        padding: 12px 24px;
                        font-size: 16px;
                        background-color: #2d89e5;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                    "> Tillbaka till startsidan</button>
                </div>
            `;



                // Populate the table with the data
                infoBox.innerHTML = tableHTML;
            } catch (err) {
                // Stop loading animation and display error
                clearInterval(loadingInterval);
                document.getElementById("loading").textContent = "Ett fel inträffade. Försök igen senare.";
                console.error(err);
            }
        };
    </script>
</body>

</html>