<!DOCTYPE html>
<!-- Default lang/dir set in header.html, updated by translate.js -->
<html>
<head>
     <!-- Meta, CSS links etc. are loaded via header.html -->
     <title>Al-Salam Moské - Skolan</title> <!-- Static title, or translate server-side -->
</head>

<body>
    <!-- Header Start -->
    <div id="header-placeholder"></div>
    <!-- Header End -->

    <!-- Form Section -->
    <div class="container mt-5 pt-5 d-flex justify-content-center">
        <div class="col-md-8">
            <h2 data-translate="school.formTitle">Registreringsformulär</h2>
            <form id="schoolsform" method="POST"
                action="https://script.google.com/macros/s/AKfycby_E_NRU7MBYK4Y0XdWnT_rTilTrCXh5MbgJ-Kf5jqU0j0tmWC4iE9pnsxTKN_7KsGWQQ/exec">
                <div class="row">
                    <!-- Child Info -->
                    <div class="col-md-6 mb-3">
                        <label for="efternamn" class="form-label" data-translate="school.childLastNameLabel">Barnets efternamn</label>
                        <input type="text" class="form-control" id="efternamn" name="Barnets efternamn" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="barnetsNamn" class="form-label" data-translate="school.childFirstNameLabel">Barnets namn</label>
                        <input type="text" class="form-control" id="barnetsNamn" name="Barnetsnamn" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="Personnummer" class="form-label" data-translate="school.childPersonnummerLabel">Barnets personnummer</label>
                        <input type="text" class="form-control" id="Personnummer" name="Barnets personnummer" required
                            pattern="\d{10}|\d{12}" data-translate-title="school.childPersonnummerTitle" title="Personnummer must be 10 or 12 digits">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="registreringsDatum" class="form-label" data-translate="school.registrationDateLabel">Registreringsdatum</label>
                        <input type="date" class="form-control" id="registreringsDatum" name="RegistreringsDatum" required>
                    </div>

                    <!-- Parent Info -->
                    <div class="col-md-6 mb-3">
                        <label for="pappansNamn" class="form-label" data-translate="school.fatherNameLabel">Pappans namn</label>
                        <input type="text" class="form-control" id="pappansNamn" name="Pappans namn" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="mammansNamn" class="form-label" data-translate="school.motherNameLabel">Mammans namn</label>
                        <input type="text" class="form-control" id="mammansNamn" name="Mammans namn" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="pappansPersonnummer" class="form-label" data-translate="school.fatherPersonnummerLabel">Pappans personnummer</label>
                        <input type="text" class="form-control" id="pappansPersonnummer" name="Pappans personnummer" required
                            pattern="\d{10}|\d{12}" data-translate-title="school.fatherPersonnummerTitle" title="Personnummer must be 10 or 12 digits">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="mammansPersonnummer" class="form-label" data-translate="school.motherPersonnummerLabel">Mammans personnummer</label>
                        <input type="text" class="form-control" id="mammansPersonnummer" name="Mammans Personnummer" required
                            pattern="\d{10}|\d{12}" data-translate-title="school.motherPersonnummerTitle" title="Personnummer must be 10 or 12 digits">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="pappansMobilnummer" class="form-label" data-translate="school.fatherMobileLabel">Pappans mobilnummer</label>
                        <input type="text" class="form-control" id="pappansMobilnummer" name="Pappans mobilnummer" required pattern="07\d{8}"
                            data-translate-title="school.fatherMobileTitle" title="Mobilnummer must start with '07' and contain 10 digits">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="mammansMobilnummer" class="form-label" data-translate="school.motherMobileLabel">Mammans mobilnummer</label>
                        <input type="text" class="form-control" id="mammansMobilnummer" name="Mammans mobilnummer" required pattern="07\d{8}"
                            data-translate-title="school.motherMobileTitle" title="Mobilnummer must start with '07' and contain 10 digits">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="pappansEpost" class="form-label" data-translate="school.fatherEmailLabel">Pappans e-post</label>
                        <input type="email" class="form-control" id="pappansEpost" name="Pappans e-post" required
                            data-translate-title="school.fatherEmailTitle" title="Ange en giltig e-postadress">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="mammansEpost" class="form-label" data-translate="school.motherEmailLabel">Mammans e-post</label>
                        <input type="email" class="form-control" id="mammansEpost" name="Mammans e-post" required
                            data-translate-title="school.motherEmailTitle" title="Ange en giltig e-postadress">
                    </div>

                     <!-- Radio Buttons Row -->
                    <div class="row mt-3"> <!-- Added margin top for spacing -->
                        <!-- Parent to Contact -->
                        <div class="col-md-6">
                            <label class="form-label d-block" data-translate="school.contactParentLabel">Vilken förälder ska vara kontaktpersonen:</label> <!-- Added d-block -->
                            <div class="form-check">
                                <input type="radio" class="form-check-input" name="kontaktForälder" id="kontaktPappa" value="Pappa" required>
                                <label for="kontaktPappa" class="form-check-label" data-translate="school.contactParentFather">Pappa</label>
                            </div>
                            <div class="form-check">
                                <input type="radio" class="form-check-input" name="kontaktForälder" id="kontaktMamma" value="Mamma">
                                <label for="kontaktMamma" class="form-check-label" data-translate="school.contactParentMother">Mamma</label>
                            </div>
                        </div>

                        <!-- School Day -->
                        <div class="col-md-6">
                            <label class="form-label d-block" data-translate="school.schoolDayLabel">Välj dag för skola (Lördag eller Söndag):</label> <!-- Added d-block -->
                            <div class="form-check">
                                <input type="radio" class="form-check-input" name="skoldag" id="skoldagLördag" value="Lördag" required>
                                <label for="skoldagLördag" class="form-check-label" data-translate="school.schoolDaySaturday">Lördag</label>
                            </div>
                            <div class="form-check">
                                <input type="radio" class="form-check-input" name="skoldag" id="skoldagSöndag" value="Söndag">
                                <label for="skoldagSöndag" class="form-check-label" data-translate="school.schoolDaySunday">Söndag</label>
                            </div>
                        </div>
                    </div>

                </div> <!-- End of main form row -->
                <button type="submit" class="btn btn-primary" style="margin-top: 20px;" data-translate="school.submitButton">Registrera</button>
            </form>
        </div>
    </div>

    <!-- Footer Start -->
    <div id="footer-placeholder"></div>
    <!-- Footer End -->

    <!-- JavaScript Libraries -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="lib/wow/wow.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>

    <!-- Template Javascript -->
    <script src="js/main.js"></script> <!-- Load main JS first -->

     <!-- Load Header and Footer & Initialize Translation -->
    <script>
        $(function () {
            // Using the same loading logic as index.html for consistency
            let headerLoaded = false;
            let footerLoaded = false;
            let initialLangApplied = false;

            function applyInitialLanguage() {
                if (headerLoaded && footerLoaded && !initialLangApplied) {
                     if (window.translatePage) {
                        const savedLang = localStorage.getItem('selectedLanguage') || 'sv';
                         if (window.translations && window.translations[savedLang]) {
                             window.translatePage(savedLang);
                             initialLangApplied = true;
                         } else { setTimeout(applyInitialLanguage, 100); }
                    } else { setTimeout(applyInitialLanguage, 100); }
                }
            }

            $("#header-placeholder").load("header.html", function(response, status, xhr) {
                if (status == "success") {
                    headerLoaded = true;
                    if (window.initializeLanguageSwitcher) window.initializeLanguageSwitcher();
                    applyInitialLanguage();
                } else { console.error("Error loading header.html:", status); }
            });

            $("#footer-placeholder").load("footer.html", function(response, status, xhr) {
                 if (status == "success") {
                    footerLoaded = true;
                    applyInitialLanguage();
                 } else { console.error("Error loading footer.html:", status); }
            });

             document.addEventListener('languageChanged', function(e) {
                 console.log("Language changed event received for:", e.detail.lang);
                 // Re-translate form elements if needed, though translatePage should cover it
             });
        });
    </script>

    <!-- Form Submission Script -->
    <script>
        window.addEventListener("load", function () {
            const form = document.getElementById('schoolsform');
            if (form) { // Check if form exists before adding listener
                form.addEventListener("submit", function (e) {
                    e.preventDefault();
                    const data = new FormData(form);
                    const action = e.target.action;
                    fetch(action, {
                        method: 'POST',
                        body: data,
                    })
                    .then(response => {
                         // Check if the fetch was successful (status 200-299)
                         // Google Apps Script redirects often return 302, fetch might follow it
                         // Or the script might return a JSON response indicating success/failure
                         // Adjust this logic based on how your Google Apps Script actually responds
                        if (!response.ok && response.type !== 'opaque') { // Opaque means cross-origin redirect often
                             // Handle actual network errors or bad responses from GAS if it returns JSON errors
                             // For now, assume redirect means success for simplicity
                             // throw new Error(`HTTP error! status: ${response.status}`);
                        }
                         // Assuming redirect implies success or Google Script handles success message
                        window.location.href = 'school-success.html'; // Redirect to your success page
                        // Or use the Stripe link if payment is next step:
                        // window.location.href = 'https://donate.stripe.com/test_cN27vE9VAeyoc9ieUW?';
                    })
                    .catch(error => {
                        console.error("Submission Error:", error);

                        // --- Translate Alert ---
                         // Helper function to get nested translation values
                         function getKeyValue(obj, keyString) {
                            if (!keyString || typeof keyString !== 'string') return null;
                            const keys = keyString.split('.');
                            let value = obj;
                            for (const key of keys) {
                                if (value && typeof value === 'object' && key in value) {
                                    value = value[key];
                                } else { return null; }
                            }
                            return typeof value === 'string' ? value : null;
                         }

                         let currentLang = 'sv'; // Default
                         try {
                             currentLang = localStorage.getItem('selectedLanguage') || 'sv';
                         } catch (e) { /* ignore */ }

                         const errorKey = "school.submissionError";
                         let errorMessage = "Submission failed. Please try again."; // Hardcoded fallback

                         if(window.translations && window.translations[currentLang]) {
                             errorMessage = getKeyValue(window.translations[currentLang], errorKey) || errorMessage;
                         } else if (window.translations && window.translations.en) {
                             errorMessage = getKeyValue(window.translations.en, errorKey) || errorMessage; // Fallback to English
                         }
                         alert(errorMessage);
                        // --- End Translate Alert ---
                    });
                });
            } else {
                console.error("School registration form not found.");
            }
        });
    </script>
    <!-- Translation scripts are loaded within header.html -->

</body>
</html>